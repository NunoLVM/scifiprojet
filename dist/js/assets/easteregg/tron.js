let externalPaused=!1;async function Draw(){if(externalPaused)return x.fillStyle="rgba(0,0,0,0.6)",x.fillRect(0,0,c.width,c.height),x.fillStyle="#fff",x.font="48px monospace",x.textAlign="center",x.fillText("PAUSED",c.width/2,c.height/2),requestAnimationFrame(Draw);if(!t){for(buffer=document.createElement("canvas"),bctx=buffer.getContext("2d"),buffer.width=c.width,buffer.height=c.height,oXv2=oYv2=oZv2=0,oX=oY=oZ=0,Rl=Pt=Yw=0,Rn=Math.random,R=(e,t,a,l)=>{let i;M=Math,A=M.atan2,H=M.hypot,l&&(X+=oX,Y+=oY,Z+=oZ),X=S(i=A(X,Z)+a)*(d=H(X,Z)),Z=C(i)*d,X=S(i=A(X,Y)+e)*(d=H(X,Y)),Y=C(i)*d,Y=S(i=A(Y,Z)+t)*(d=H(Y,Z)),Z=C(i)*d,X+=oXv2,Y+=oYv2,Z+=oZv2,l&&(Y+=0,Z+=4)},R2=(e,t,a,l=!1)=>{M=Math,A=M.atan2,H=M.hypot,l&&(X-=oX,Y-=oY,Z-=oZ),X=S(p=A(X,Y)+e)*(d=H(X,Y)),Y=C(p)*d,Y=S(p=A(Y,Z)+t)*(d=H(Y,Z)),Z=C(p)*d,X=S(p=A(X,Z)+a)*(d=H(X,Z)),Z=C(p)*d},Q=()=>[c.width/2+X/Z*700,c.height/2+Y/Z*700+mofy],Q2=()=>[c.width/2+X/Z*2400*tscl1+21.95*tmofx-480+mofx1,c.height/2+Y/Z*2400*tscl1+tmofy+mofy1],Q3=()=>[c.width/2+X/Z*1200*tscl2/1.33+21.95*tmofx+480+mofx2,c.height/2+Y/Z*1200*tscl2/1.33+tmofy+mofy2],Q2p=()=>[X/Z*2400*tscl1,Y/Z*2400*tscl1],Q3p=()=>[X/Z*1200*tscl2/1.33,Y/Z*1200*tscl2/1.33],Q4=()=>[c.width-155+X/Z*33.975,c.height-155+Y/Z*33.975],I=(e,t,a,l,i,r,s,h)=>(K=((s-i)*(t-r)-(h-r)*(e-i))/(J=(h-r)*(a-e)-(s-i)*(l-t)))>=0&&K<1&&(L=((a-e)*(t-r)-(l-t)*(e-i))/J)>=0&&L<1?[e+K*(a-e),t+K*(l-t)]:0,Cube=e=>{for(CB=[],j=6;j--;CB=[...CB,b])for(b=[],i=4;i--;)b=[...b,[(a=[S(p=2*Math.PI/4*i+Math.PI/4),C(p),2**.5/2])[j%3]*(l=j<3?e/2**.5:-e/2**.5),a[(j+1)%3]*l,a[(j+2)%3]*l]];return CB},subbed=(e,t,i,r)=>{for(let t=e;t--;)base=r,r=[],base.map((e=>{switch(l=0,X1=e[l][0],Y1=e[l][1],Z1=e[l][2],l=1,X2=e[l][0],Y2=e[l][1],Z2=e[l][2],l=2,X3=e[l][0],Y3=e[l][1],Z3=e[l][2],e.length>3&&(l=3,X4=e[l][0],Y4=e[l][1],Z4=e[l][2],e.length>4&&(l=4,X5=e[l][0],Y5=e[l][1],Z5=e[l][2])),mx1=(X1+X2)/2,my1=(Y1+Y2)/2,mz1=(Z1+Z2)/2,mx2=(X2+X3)/2,my2=(Y2+Y3)/2,mz2=(Z2+Z3)/2,a=[],e.length){case 3:mx3=(X3+X1)/2,my3=(Y3+Y1)/2,mz3=(Z3+Z1)/2,X=X1,Y=Y1,Z=Z1,a=[...a,[X,Y,Z]],X=mx1,Y=my1,Z=mz1,a=[...a,[X,Y,Z]],X=mx3,Y=my3,Z=mz3,a=[...a,[X,Y,Z]],r=[...r,a],a=[],X=mx1,Y=my1,Z=mz1,a=[...a,[X,Y,Z]],X=X2,Y=Y2,Z=Z2,a=[...a,[X,Y,Z]],X=mx2,Y=my2,Z=mz2,a=[...a,[X,Y,Z]],r=[...r,a],a=[],X=mx3,Y=my3,Z=mz3,a=[...a,[X,Y,Z]],X=mx2,Y=my2,Z=mz2,a=[...a,[X,Y,Z]],X=X3,Y=Y3,Z=Z3,a=[...a,[X,Y,Z]],r=[...r,a],a=[],X=mx1,Y=my1,Z=mz1,a=[...a,[X,Y,Z]],X=mx2,Y=my2,Z=mz2,a=[...a,[X,Y,Z]],X=mx3,Y=my3,Z=mz3,a=[...a,[X,Y,Z]],r=[...r,a];break;case 4:mx3=(X3+X4)/2,my3=(Y3+Y4)/2,mz3=(Z3+Z4)/2,mx4=(X4+X1)/2,my4=(Y4+Y1)/2,mz4=(Z4+Z1)/2,cx=(X1+X2+X3+X4)/4,cy=(Y1+Y2+Y3+Y4)/4,cz=(Z1+Z2+Z3+Z4)/4,X=X1,Y=Y1,Z=Z1,a=[...a,[X,Y,Z]],X=mx1,Y=my1,Z=mz1,a=[...a,[X,Y,Z]],X=cx,Y=cy,Z=cz,a=[...a,[X,Y,Z]],X=mx4,Y=my4,Z=mz4,a=[...a,[X,Y,Z]],r=[...r,a],a=[],X=mx1,Y=my1,Z=mz1,a=[...a,[X,Y,Z]],X=X2,Y=Y2,Z=Z2,a=[...a,[X,Y,Z]],X=mx2,Y=my2,Z=mz2,a=[...a,[X,Y,Z]],X=cx,Y=cy,Z=cz,a=[...a,[X,Y,Z]],r=[...r,a],a=[],X=cx,Y=cy,Z=cz,a=[...a,[X,Y,Z]],X=mx2,Y=my2,Z=mz2,a=[...a,[X,Y,Z]],X=X3,Y=Y3,Z=Z3,a=[...a,[X,Y,Z]],X=mx3,Y=my3,Z=mz3,a=[...a,[X,Y,Z]],r=[...r,a],a=[],X=mx4,Y=my4,Z=mz4,a=[...a,[X,Y,Z]],X=cx,Y=cy,Z=cz,a=[...a,[X,Y,Z]],X=mx3,Y=my3,Z=mz3,a=[...a,[X,Y,Z]],X=X4,Y=Y4,Z=Z4,a=[...a,[X,Y,Z]],r=[...r,a];break;case 5:cx=(X1+X2+X3+X4+X5)/5,cy=(Y1+Y2+Y3+Y4+Y5)/5,cz=(Z1+Z2+Z3+Z4+Z5)/5,mx3=(X3+X4)/2,my3=(Y3+Y4)/2,mz3=(Z3+Z4)/2,mx4=(X4+X5)/2,my4=(Y4+Y5)/2,mz4=(Z4+Z5)/2,mx5=(X5+X1)/2,my5=(Y5+Y1)/2,mz5=(Z5+Z1)/2,X=X1,Y=Y1,Z=Z1,a=[...a,[X,Y,Z]],X=X2,Y=Y2,Z=Z2,a=[...a,[X,Y,Z]],X=cx,Y=cy,Z=cz,a=[...a,[X,Y,Z]],r=[...r,a],a=[],X=X2,Y=Y2,Z=Z2,a=[...a,[X,Y,Z]],X=X3,Y=Y3,Z=Z3,a=[...a,[X,Y,Z]],X=cx,Y=cy,Z=cz,a=[...a,[X,Y,Z]],r=[...r,a],a=[],X=X3,Y=Y3,Z=Z3,a=[...a,[X,Y,Z]],X=X4,Y=Y4,Z=Z4,a=[...a,[X,Y,Z]],X=cx,Y=cy,Z=cz,a=[...a,[X,Y,Z]],r=[...r,a],a=[],X=X4,Y=Y4,Z=Z4,a=[...a,[X,Y,Z]],X=X5,Y=Y5,Z=Z5,a=[...a,[X,Y,Z]],X=cx,Y=cy,Z=cz,a=[...a,[X,Y,Z]],r=[...r,a],a=[],X=X5,Y=Y5,Z=Z5,a=[...a,[X,Y,Z]],X=X1,Y=Y1,Z=Z1,a=[...a,[X,Y,Z]],X=cx,Y=cy,Z=cz,a=[...a,[X,Y,Z]],r=[...r,a],a=[]}}));return i&&(ip1=i,ip2=1-i,r=r.map((e=>e=e.map((e=>(X=e[0],Y=e[1],Z=e[2],d=Math.hypot(X,Y,Z),X/=d,Y/=d,Z/=d,X*=t/2*ip1+d*ip2,Y*=t/2*ip1+d*ip2,Z*=t/2*ip1+d*ip2,[X,Y,Z])))))),r},subDividedCube=(e,t,a=0)=>subbed(t,e,a,Cube(e)),stroke=(e,t,a,l,i=1,r=!1)=>{e&&(x.strokeStyle=e,r&&x.closePath(),x.lineWidth=Math.min(200,50/(1+Z)*a),l&&(x.globalAlpha=.25*i,x.stroke(),x.lineWidth/=3),x.globalAlpha=1*i,x.stroke()),t&&(x.globalAlpha=1*i,x.fillStyle=t,x.fill())},toggleView=()=>{view++,view%=views},checkPath=(e,t=0,a=0,i=0)=>{let r,s,h=!1;if(!(e.path.length<2))return e.path.map(((p,c)=>{c>2||(r=e.path.length-c,s=e.path.length-c-1,c?(X1=e.path[r][0],Y1=e.path[r][1],Z1=e.path[r][2]):(X1=e.X+t,Y1=e.Y+a,Z1=e.Z+i),X2=e.path[s][0],Y2=e.path[s][1],Z2=e.path[s][2],h||players.map(((t,a)=>{(t.alive&&!c||a!=e.id)&&(s=t.path.length-1,X3=t.path[s][0],Y3=t.path[s][1],Z3=t.path[s][2],X4=t.X,Y4=t.Y,Z4=t.Z,(l=I(X1,Z1,X2,Z2,X3,Z3,X4,Z4))&&(l[2]=a,h=l)),h||t.path.map(((i,p)=>{r=p,s=p-1,(a!=e.id||p!=c)&&p&&p<t.path.length-2&&(X3=t.path[r][0],Y3=t.path[r][1],Z3=t.path[r][2],X4=t.path[s][0],Y4=t.path[s][1],Z4=t.path[s][2],(l=I(X1,Z1,X2,Z2,X3,Z3,X4,Z4))&&(l[2]=a,h=l))}))})),h||perimeter.map(((e,t)=>{t&&(r=t-1,s=t,X3=perimeter[r][0],Y3=perimeter[r][1],Z3=perimeter[r][2],X4=perimeter[s][0],Y4=perimeter[s][1],Z4=perimeter[s][2],(l=I(X1,Z1,X2,Z2,X3,Z3,X4,Z4))&&(h=l))})))})),h},spawnPlayer=(e=-1)=>(spawnG=.8*perG,X=(Rn()-.5)*spawnG,Y=0,Z=(Rn()-.5)*spawnG,theta=0,iPv=Math.min(playerMaxSpeed,2*playerMinSpeed),e==camSelected&&(oXv=-X,oYv=0,oZv=-Z,oX=-X,oY=0,oZ=-Z,Rl=0,Pt=-.5,Yw=0,Rlv=0,Ptv=-.5,Ywv=0),{X,Y,Z,theta,AITimer:0,score:void 0!==players[e]?players[e].score:0,AITurnTimer:0,speed:2*iPv,alive:!0,ox:X,oy:Y,oz:Z,path:[[X,Y,Z],[X,Y,Z]],keys:Array(128).fill(!1),keyTimers:Array(128).fill(0),name:void 0!==players[e]?players[e].name:0==e?"human":`AI player ${e}`,respawnPending:!1,id:-1==e?players.length:e}),spawnFlashNotice=(e,t)=>{flashNotices=[...flashNotices,[e,t,2]]},drawLeaderboard=()=>{margin=5,x.globalAlpha=.7;let e=28,t=(2+players.length)*e;x.fillStyle="#001c",x.strokeStyle="#fff2",x.lineWidth=2,x.fillRect(margin,c.height-t-margin,400,t),x.strokeRect(margin,c.height-t-margin,400,t),x.globalAlpha=1,X2=80,Y2=40,X1=400-X2-margin,Y1=c.height-t-3*margin,x.lineWidth=10,x.font="40px monospace",x.textAlign="center",x.strokeRect(X1,20+Y1,X2,Y2),x.fillStyle="#000",x.fillRect(X1,20+Y1,X2,Y2),str="[L]",x.fillStyle="#fff",x.fillText(str,X1+X2/2,Y1+50),x.textAlign="left",x.font="28px monospace",x.fillStyle="#0FF",x.strokeStyle="#40F4",x.strokeText("LEADERBOARD",2*margin,c.height-2*margin-(players.length+1)*e+1.12),x.fillText("LEADERBOARD",2*margin,c.height-2*margin-(players.length+1)*e+1.12),x.fillStyle="#0F8",x.strokeStyle="#40F4",x.strokeText(" # SCORE  NAME",2*margin,c.height-2*margin-players.length*e+1.12),x.fillText(" # SCORE  NAME",2*margin,c.height-2*margin-players.length*e+1.12),x.fillStyle="#fff",x.strokeStyle="#8804",scores=[],players.map(((e,t)=>{player=players[players.length-t-1],scores=[...scores,{score:player.score,name:player.name}]})),scores.sort(((e,t)=>e.score-t.score)),scores.map(((t,a)=>{str=` ${scores.length-a}   ${t.score}    ${t.name}`,x.strokeText(str,2*margin,c.height-2*margin-a*e+1.12),x.fillText(str,2*margin,c.height-2*margin-a*e+1.12)})),x.textAlign="center"},drawOverview=()=>{x.globalAlpha=1,margin=5;let e=300,a=300;x.fillStyle="#001c",x.strokeStyle="#40fc",x.lineWidth=2,x.fillRect(c.width-e-margin,c.height-a-margin,e,a),x.strokeRect(c.width-e-margin,c.height-a-margin,e,a),x.strokeStyle="#fff3",X2=80,Y2=40,X1=c.width-e-X2-3*margin,Y1=c.height-Y2-6*margin,x.lineWidth=10,x.font="40px monospace",x.textAlign="center",x.strokeRect(X1,20+Y1,X2,Y2),x.fillStyle="#000",x.fillRect(X1,20+Y1,X2,Y2),str="[O]",x.fillStyle="#fff",x.fillText(str,X1+X2/2,Y1+50),cond=!0,players.map(((e,a)=>{e.alive&&(X=e.X,Y=e.Y,Z=e.Z,R(0,-Math.PI/2,0,0),Z=32,l=Q4(),s=Math.min(1e3,2e3/Z*(.5+.25*S(99*t))),x.fillStyle=`hsla(${40+360/players.length*a+90},99%,50%,0.1)`,x.fillRect(l[0]-s/2,l[1]-s/2,s,s),s/=3,x.fillStyle=`hsla(${360/players.length*a+90},99%,50%,0.5)`,x.fillRect(l[0]-s/2,l[1]-s/2,s,s),s/=3,x.fillStyle="#fff",x.fillRect(l[0]-s/2,l[1]-s/2,s,s)),e.path=e.path.filter(((t,a)=>e.path.length<maxPlayerLength||a)),x.beginPath(),e.path.map(((t,a)=>{l1=a,X1=X=e.path[l1][0],Y1=Y=cond?0:e.path[l1][1],Z1=Z=e.path[l1][2],(d1=Math.hypot(X-players[camSelected].X,Z-players[camSelected].Z))<500&&(R(0,-Math.PI/2,0,0),Z=32,Z>0&&x.lineTo(...Q4()))})),col1=e.alive?`hsla(${360/players.length*a+90},99%,50%,1)`:"#888",col2="",Z=50,stroke(col1,col2,2,!1)})),s=.33,w_=160*s*.9,h_=664*s*.95,x.fillStyle="#000",x.fillRect(c.width-w_,c.height-h_-316,.9*w_,h_),d=players[camSelected].speed/playerMaxSpeed,x.fillStyle=`hsla(${180-180*d}, 99%,50%,1)`,x.fillRect(c.width-w_,c.height-316,.9*w_,-h_*d),w_=160*s,h_=664*s,x.strokeStyle="#fff8",x.lineWidth=4,x.strokeRect(c.width-w_+4,c.height-h_-305,w_-8,h_-10),x.strokeStyle="#fff4",X2=40,Y2=21,X1=c.width-X2/2-28,Y1=c.height/2-18,x.lineWidth=10,x.font="20px monospace",x.textAlign="center",x.strokeRect(X1,Y1,X2,Y2),x.fillStyle="#000",x.fillRect(X1,Y1,X2,Y2),str="SPD",x.fillStyle="#fff",x.fillText(str,X1+X2/2,Y1+16)},init=()=>{if(perG=200,perSp=2**.5/2*2,camSelected=0,AIFreq=0,flashNotices=[],maxPlayerLength=500,showOverview=!0,showLeaderboard=!0,paused=!1,AIOpponents=4,AITurnInterval=1/60*10,cl=36,br=36,rw=1,playerMaxSpeed=2,playerMinSpeed=.05,iPv=Math.min(playerMaxSpeed,2*playerMinSpeed),sp=1.333,keyTimerInterval=.25,views=3,view=1,keep=[8,11],mofx=mofy=0,tmofx=tmofy=0,scl1=view<=1?.5:1,scl2=(view>=1?.4:.66)/(.5+2*iPv),tscl1=scl1,tscl2=scl2,viewFrame=subDividedCube(1,1,0).filter(((e,t)=>keep.filter((e=>e==t)).length)).map((e=>(s__=2.73,e.map((e=>{e[0]*=16*s__,e[1]*=18*s__,e[2]*=0,e[1]+=4.5*s__})),e))),"undefined"==typeof players){players=[];for(let e=0;e<AIOpponents+1;e++)players=[...players,spawnPlayer(e)]}iViewFrame=structuredClone(viewFrame)},init(),sparks=[],iSparkv=.125,spawnSparks=(e,t,a,l)=>{for(let i=300;i--;)v=Rn()**1*iSparkv,vx=S(l.theta)*l.speed/6+S(p=2*Math.PI*Rn()**.5)*S(q=Rn()<.5?Math.PI/2*Rn()**.5:Math.PI-Math.PI/2*Rn()**.5)*v,vy=C(q)*v/4,vz=C(l.theta)*l.speed/6+C(p)*S(q)*v,sparks=[...sparks,[e,t,a,vx,vy,vz,.5+Rn()/2]]},accel=e=>{e.alive&&(e.speed+=.075,e.speed=Math.min(playerMaxSpeed,e.speed))},deccel=e=>{e.alive&&(e.speed-=.1,e.speed=Math.max(playerMinSpeed,e.speed))},turnLeft=(e,t=!1)=>{e.theta-=Math.PI/2,e.alive&&!t&&(e.path=[...e.path,[e.X,e.Y,e.Z]],vx=S(e.theta)*e.speed,vy=0,vz=C(e.theta)*e.speed,e.X+=vx,e.Y+=vy,e.Z+=vz,e.path[e.path.length-1]=[e.X,e.Y,e.Z],(l=checkPath(e))&&e.alive&&killPlayer(e,l))},turnRight=(e,t=!1)=>{e.theta+=Math.PI/2,e.alive&&!t&&(e.path=[...e.path,[e.X,e.Y,e.Z]],vx=S(e.theta)*e.speed,vy=0,vz=C(e.theta)*e.speed,e.X+=vx,e.Y+=vy,e.Z+=vz,e.path[e.path.length-1]=[e.X,e.Y,e.Z],(l=checkPath(e))&&e.alive&&killPlayer(e,l))},window.onkeydown=e=>{players[0].keys[e.keyCode]=!0},window.onkeyup=e=>{players[0].keys[e.keyCode]=!1,players[0].keyTimers[e.keyCode]=0},window.onload=()=>c.focus(),resetGame=()=>{players[0]=spawnPlayer(0)},doKeys=e=>{e.keys.map(((a,l)=>{if(a&&e.keyTimers[l]<=t)switch(e.keyTimers[l]=t+keyTimerInterval,l){case 80:paused=!paused;break;case 76:showLeaderboard=!showLeaderboard;break;case 79:showOverview=!showOverview;break;case 32:e.alive||resetGame();break;case 37:paused||turnLeft(e);break;case 38:paused||accel(e);break;case 39:paused||turnRight(e);break;case 40:paused||deccel(e);break;case 86:toggleView()}}))},base_shp=subDividedCube(sp,0,0).filter(((e,t)=>1==t)).map((e=>(e.map((e=>{e[1]*=0})),e))),shapes=Array(cl*rw*br).fill().map(((e,t)=>(X=(t%cl-cl/2+.5)*sp,Y=((t/cl|0)%rw-rw/2+.5)*sp,Z=((t/rw/cl|0)-br/2+.5)*sp,shp=structuredClone(base_shp),[X,Y,Z,shp]))),drawSparks=()=>{sparks=sparks.filter((e=>e[6]>0));for(let e=1==view?2:1;e--;)cond=2!==view&&!e,sparks.map((t=>{omit=!1,e||(t[0]+=t[3],t[1]+=t[4],t[2]+=t[5]),X=t[0],Y=cond?0:t[1],Z=t[2],cond?(R(Rl,-Math.PI/2,Yw,0),Z+=8):R(Rl,Pt,Yw,1),l=cond?Q3():Q2(),1==view&&(e?(l[0]>c.width/2&&(omit=!0),l[0]=Math.min(c.width/2,l[0])):(l[0]<c.width/2&&(omit=!0),l[0]=Math.max(c.width/2,l[0]))),!omit&&Z>0&&(s=Math.min(1e4,1200/Z*t[6]),x.fillStyle="#ff000006",x.fillRect(l[0]-s/2,l[1]-s/2,s,s),s/=3,x.fillStyle="#ff880012",x.fillRect(l[0]-s/2,l[1]-s/2,s,s),s/=3,x.fillStyle="#ffffffff",x.fillRect(l[0]-s/2,l[1]-s/2,s,s)),e||(t[6]-=.0025)}))},AILookAhead=1+10*iPv,doAI=e=>{e.AITimer<=t&&(e.AITimer=t+AIFreq,Rn()<.01&&(Rn()<.4?accel:deccel)(e),tplayer=structuredClone(e),vx=S(tplayer.theta)*tplayer.speed,vy=0,vz=C(tplayer.theta)*tplayer.speed,d=Math.hypot(vx,vy,vz),vx/=d,vy/=d,vz/=d,vx*=AILookAhead,vy*=AILookAhead,vz*=AILookAhead,l=tplayer.path.length-1,tplayer.path[l][0]+=vx,tplayer.path[l][1]+=vy,tplayer.path[l][2]+=vz,checkPath(tplayer)?Rn()<.5?(turnRight(tplayer,!0),vx=S(tplayer.theta)*tplayer.speed,vy=0,vz=C(tplayer.theta)*tplayer.speed,d=Math.hypot(vx,vy,vz),vx/=d,vy/=d,vz/=d,vx*=AILookAhead,vy*=AILookAhead,vz*=AILookAhead,checkPath(tplayer,vx,vy,vz)?turnLeft(e):turnRight(e)):(turnLeft(tplayer,!0),vx=S(tplayer.theta)*tplayer.speed,vy=0,vz=C(tplayer.theta)*tplayer.speed,d=Math.hypot(vx,vy,vz),vx/=d,vy/=d,vz/=d,vx*=AILookAhead,vy*=AILookAhead,vz*=AILookAhead,checkPath(tplayer,vx,vy,vz)?turnRight(e):turnLeft(e)):Rn()<.0025&&e.AITurnTimer<=t&&(e.AITurnTimer=t+AITurnInterval,Rn()<.5?(turnRight(tplayer,!0),checkPath(tplayer)||turnRight(e)):(turnLeft(tplayer,!0),checkPath(tplayer)||turnLeft(e))))},killPlayer=(e,t)=>{e.alive&&(spawnSparks(l1[0],0,l1[1],e),e.alive=!1,e.speed=playerMinSpeed,l2=e.path.length-1,e.X=l1[0],e.Y=0,e.Z=l1[1],e.path[l2][0]=l1[0],e.path[l2][1]=0,e.path[l2][2]=l1[1],"number"==typeof t[2]&&e.id!=t[2]&&players[t[2]].alive&&(players[t[2]].score++,spawnFlashNotice(`POINT!, ${players[t[2]].name}`,`hsla(${360/players.length*t[2]+90},99%,50%,1)`)))},drawPlayers=()=>{for(m=1==view?2:1;m--;)cond=2!==view&&!m,players.map(((e,a)=>{e.path=e.path.filter(((t,a)=>e.path.length<maxPlayerLength||a)),e.path.map(((t,i)=>{i&&(omit=!1,x.beginPath(),l1=i,l2=i-1,X1=X=e.path[l1][0],Y1=Y=cond?0:e.path[l1][1],Z1=Z=e.path[l1][2],(d1=Math.hypot(X-players[camSelected].X,Z-players[camSelected].Z))<50&&(cond?(R(Rl,-Math.PI/2,Yw,0),Z+=8):R(Rl,Pt,Yw,1),l=cond?Q3():Q2(),1==view&&(m?(l[0]>c.width/2+300&&(omit=!0),l[0]=Math.min(c.width/2,l[0])):(l[0]<c.width/2&&(omit=!0),l[0]=Math.max(c.width/2,l[0]))),Z>0&&x.lineTo(...l),omit||(X2=X=e.path[l2][0],Y2=Y=cond?0:e.path[l2][1],Z2=Z=e.path[l2][2],cond?(R(Rl,-Math.PI/2,Yw,0),Z+=8):R(Rl,Pt,Yw,1),l=cond?Q3():Q2(),1==view&&(m?(l[0]>c.width/2+300&&(omit=!0),l[0]=Math.min(c.width/2,l[0])):l[0]=Math.max(c.width/2,l[0])),Z>0&&x.lineTo(...l),cond?(col1=e.alive?`hsla(${360/players.length*a+90},99%,50%,${1/(1+d1**10/1e14)})`:`hsla(${360/players.length*a+90},0%,50%,${1/(1+d1**10/1e14)})`,col2="",omit||stroke(col1,col2,2,!0)):omit||(X=X2,Y=Y2-1,Z=Z2,R(Rl,Pt,Yw,1),l=Q2(),1==view&&(m?(l[0]>c.width/2+300&&(omit=!0),l[0]=Math.min(c.width/2,l[0])):l[0]=Math.max(c.width/2,l[0])),Z>0&&x.lineTo(...l),omit||(X=X1,Y=Y1-1,Z=Z1,R(Rl,Pt,Yw,1),l=Q2(),1==view&&(m?(l[0]>c.width/2+300&&(omit=!0),l[0]=Math.min(c.width/2,l[0])):l[0]=Math.max(c.width/2,l[0])),Z>0&&x.lineTo(...l),col1="",col2=e.alive?`hsla(${360/players.length*a+90},99%,50%,${.5/(1+d1**10/1e14)})`:`hsla(${360/players.length*a+90},0%,50%,${.5/(1+d1**10/1e14)})`,omit||stroke(col1,col2,cond?2:1,!0))))))})),e.alive&&!paused&&(m||(vx=S(e.theta)*e.speed,vy=0,vz=C(e.theta)*e.speed,tplayer=structuredClone(e),tplayer.X+=vx,tplayer.Y+=vy,tplayer.Z+=vz,(l1=checkPath(tplayer))?e.alive&&killPlayer(e,l1):(X=e.X+=vx,Y=e.Y+=vy,Z=e.Z+=vz,(X>perSp*perG/2||X<-perSp*perG/2||Z>perSp*perG/2||Z<-perSp*perG/2)&&killPlayer(e,[e.X,e.Z]),(60*t|0)%(20/(1+20*e.speed)|0)?(e.path[e.path.length-1][0]=X,e.path[e.path.length-1][1]=Y,e.path[e.path.length-1][2]=Z):e.path=[...e.path,[X,Y,Z]]))),a||e.alive||(x.fillStyle="#18000688",x.fillRect(0,0,c.width,c.height),x.font=(fs=100)+"px monospace",x.fillStyle="#f02",x.strokeStyle="#000",x.lineWidth=16,x.strokeText("ded",c.width/2,c.height/2-1*fs),x.fillText("ded",c.width/2,c.height/2-1*fs),x.strokeText("hit the space key",c.width/2,c.height/2+1*fs),x.fillText("hit the space key",c.width/2,c.height/2+1*fs))}))},drawBoards=()=>{for(m=1==view?2:1;m--;)cond=2!==view&&!m,cond&&2!==view&&viewFrame.map(((e,t)=>{0==t&&(x.beginPath(),e.map(((e,a)=>{X=iViewFrame[t][a][0],Y=iViewFrame[t][a][1],Z=iViewFrame[t][a][2],Z+=8,Z>0&&x.lineTo(...Q())})),col1="",col2="#000",stroke(col1,col2,5,!0))})),shapes.map(((e,t)=>{if(nx=1+Math.round(t%cl/sp*2),ny=1+Math.round((t/cl|0)/sp*2),cnd=nx%3&&ny%3,cnd){for(tx=e[0],ty=e[1],tz=e[2];tx-players[camSelected].X>cl*sp/2;)tx-=cl*sp;for(;tx-players[camSelected].X<-cl*sp/2;)tx+=cl*sp;for(;tz-players[camSelected].Z>br*sp/2;)tz-=br*sp;for(;tz-players[camSelected].Z<-br*sp/2;)tz+=br*sp;e[3].map(((e,a)=>{x.beginPath(),e.map((e=>{X=e[0]+tx,Y=cond?0:e[1]+ty,Z=e[2]+tz,cond?(R(Rl,-Math.PI/2,Yw,0),Z+=8):R(Rl,Pt,Yw,1),l=cond?Q3():Q2(),1!=view||m||(l[0]=Math.max(c.width/2,l[0])),Z>0&&x.lineTo(...l)})),col1="",col2=(t+(t/br|0)%4)%4?"#4400ff20":"#00ff8820",oga=1/(1+Math.hypot(tx-players[camSelected].X,tz-players[camSelected].Z)**8/1e10),stroke(col1,col2,4,!1,oga)}))}})),perimeter.map((e=>{tx=e[0],ty=e[1],tz=e[2],(d1=Math.hypot(tx-players[camSelected].X,tz-players[camSelected].Z))<50&&(oga=1/(1+d1**10/1e14),oga>.025&&e[3].map((e=>{x.beginPath(),e.map((e=>{X=tx+e[0],Y=cond?0:ty+e[1],Z=tz+e[2],cond?(R(Rl,-Math.PI/2,Yw,0),Z+=8):R(Rl,Pt,Yw,1),l=cond?Q3():Q2(),1!=view||m||(l[0]=Math.max(c.width/2,l[0])),Z>0&&x.lineTo(...l)})),col1=2===view||m?"":"#888",col2="#888",stroke(col1,col2,4,!1,oga)})))})),x.globalAlpha=1},mofx1=mofy1=mofx2=mofy2=0,oXv=-players[camSelected].X,oX=oXv,oYv=-players[camSelected].Y,oY=oYv,oZv=-players[camSelected].Z,oZ=oZv,base_peri_shp=[],perimeter=[],i=4;i--;)X=S(p=2*Math.PI/4*i+Math.PI/4),Y=C(p),Z=0,a=[...a,[X,Y,Z]];for(base_peri_shp=[...base_peri_shp,a],b=[],i=perG;i--;)tx=(i-perG/2+.5)*perSp,ty=0,tz=perG/2*perSp,shp=structuredClone(base_peri_shp),b=[...b,[tx,ty,tz,shp]];for(perimeter=[...perimeter,...b],i=3;i--;)e=structuredClone(b),e.map((e=>{X=e[0],Y=e[1],Z=e[2],R(0,0,2*Math.PI/4*(i+1)),e[0]=X,e[1]=Y,e[2]=Z,e[3].map((e=>{e.map((e=>{X=e[0],Y=e[1],Z=e[2],R(0,0,2*Math.PI/4*(i+1)),e[0]=X,e[1]=Y,e[2]=Z}))}))})),perimeter=[...perimeter,...e];perimeter.map((e=>{e[3].map((e=>{e.map((e=>{e[1]*=2,e[0],e[1]-=1*perSp,e[2]}))}))}))}if(x.globalAlpha=1,x.fillStyle="#000e",x.fillRect(0,0,c.width,c.height),x.lineJoin=x.lineCap="butt",boardHoming=10,l=players[camSelected].path.length){el=players[camSelected].path[l-1];for(let e=2;e--;)X=el[0],Y=e?0:el[1],Z=el[2],e&&(R(Rl,-Math.PI/2,Yw,0),Z+=8,l2=Q3p(),mofx2=-l2[0]/1,mofy2=-l2[1]/1)}for(min=1.1*(.2+players[camSelected].speed),oXv=-players[camSelected].X,oYv=-players[camSelected].Y,oZv=-players[camSelected].Z,oXv2=.2,oYv2=(view,0),oZv2=2==view?8:0,vx=(oXv-oX)/boardHoming,vy=(oYv-oY)/boardHoming,vz=(oZv-oZ)/boardHoming,d1=Math.hypot(vx,vy,vz)+1e-4,d2=Math.min(d1,min),vx/=d1,vy/=d1,vz/=d1,vx*=d2,vy*=d2,vz*=d2,oX+=vx,oY+=vy,oZ+=vz,Rlv=0,min=.05,v=(Rlv-Rl)/boardHoming,d1=Math.abs(v)+1e-4,d2=Math.min(d1,min),v/=d1,v*=d2,Rl+=v,Ptv=-.5,v=(Ptv-Pt)/boardHoming,d1=Math.abs(v)+1e-4,d2=Math.min(d1,min),v/=d1,v*=d2,Pt+=v,Ywv=-players[camSelected].theta,v=(Ywv-Yw)/boardHoming,d1=Math.abs(v)+1e-4,d2=Math.min(d1,min),v/=d1,v*=d2,Yw+=v,players.map((e=>{doKeys(e)})),homing=5,viewFrame.map(((e,t)=>{x.beginPath(),e.map(((e,a)=>{switch(view){case 0:s_=t?0:2,ofx=-8*s__;break;case 1:s_=1,ofx=0;break;case 2:s_=t?2:0,ofx=8*s__}X1=e[0]*s_+ofx,Y1=e[1],Z1=e[2],X2=iViewFrame[t][a][0],Y2=iViewFrame[t][a][1],Z2=iViewFrame[t][a][2],vx=X1-X2,vy=Y1-Y2,vz=Z1-Z2,d1=Math.hypot(vx,vy,vz)+.001,d2=Math.min(d1,homing),vx/=d1,vy/=d1,vz/=d1,vx*=d2,vy*=d2,vz*=d2,X=iViewFrame[t][a][0]+=vx,Y=iViewFrame[t][a][1]+=vy,Z=iViewFrame[t][a][2]+=vz,Z+=8,Z>0&&x.lineTo(...Q())})),col1="#0f8",col2="",stroke(col1,col2,2,!1)})),mofx=iViewFrame[1][0][0],mofy=0,drawBoards(),x.strokeStyle="#fff4",X1=40*mofx-60,Y1=0,X2=120,Y2=50,x.lineWidth=10,x.font="40px monospace",x.textAlign="center",m=3;m--;){switch(lx=875*(m-1),x.strokeRect(960+X1+lx,20+Y1,X2,Y2),x.fillStyle="#000",x.fillRect(960+X1+lx,20+Y1,X2,Y2),m){case 0:str="3D";break;case 1:str="←v→";break;case 2:str="2D"}x.fillStyle="#fff",x.fillText(str,960+X1+60+lx,56)}scl1=view<=1?.25:.5,scl2=(view>=1?.4:.66)/2,tmofx+=(mofx-tmofx)/10,tmofy+=(mofy-tmofy)/10,tscl1+=(scl1-tscl1)/20,tscl2+=(scl2-tscl2)/20,players.map(((e,t)=>{t&&!e.alive?e.respawnPending||(e.respawnPending=!0,setTimeout((()=>{players[t]=spawnPlayer(t)}),2e3)):!paused&&t&&e.alive&&doAI(e)})),drawSparks(),drawPlayers(),showOverview&&drawOverview(),showLeaderboard&&drawLeaderboard(),flashNotices=flashNotices.filter((e=>e[2]>0)),flashNotices.length&&(x.fillStyle=flashNotices[l=flashNotices.length-1][1],x.globalAlpha=Math.min(1,flashNotices[l][2]),x.textAlign="center",x.fillRect(0,0,c.width,c.height),x.fillStyle="#fff8",x.font=(fs=100)+"px monospace",x.strokeStyle="#000a",x.lineWidth=10,x.strokeText(flashNotices[l][0],c.width/2,c.height/2+fs/4),x.fillText(flashNotices[l][0],c.width/2,c.height/2+fs/4),flashNotices[l][2]-=.05),x.globalAlpha=1,x.strokeStyle="#fff4",X2=paused?280:240,Y2=50,X1=-X2/2,Y1=c.height-Y2-10,x.lineWidth=10,x.font="40px monospace",x.textAlign="center",x.strokeRect(960+X1,Y1,X2,Y2),x.fillStyle=paused?"#601":"#021",x.fillRect(960+X1,Y1,X2,Y2),str=paused?"unpause [p]":" pause [p] ",x.fillStyle="#fff",x.fillText(str,960,Y1+33),t+=1/60,requestAnimationFrame(Draw)}window.addEventListener("message",(e=>{"pause"===e.data&&(externalPaused=!0),"resume"===e.data&&(externalPaused=!1)})),document.addEventListener("keydown",(e=>{"p"===e.key.toLowerCase()&&externalPaused&&(externalPaused=!1)})),document.addEventListener("click",(()=>{externalPaused&&(externalPaused=!1)})),window.addEventListener("blur",(()=>externalPaused=!0)),c=document.querySelector("#c"),c.width=1920,c.height=1080,x=c.getContext("2d"),C=Math.cos,S=Math.sin,t=0,T=Math.tan,rsz=window.onresize=()=>{let e,t=document.body,a=.5625;t.clientHeight/t.clientWidth>a?(c.style.width=(e=t.clientWidth)-20+"px",c.style.height=e*a-20+"px"):(c.style.height=(e=t.clientHeight)-20+"px",c.style.width=e/a-20+"px")},rsz(),Draw();